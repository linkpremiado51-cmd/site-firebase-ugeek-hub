<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AniGeek Studio Enterprise - v12.1 Analytics Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #3730a3;
            --secondary: #0f172a; --accent: #0ea5e9;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --analytics: #8b5cf6;
            --bg: #f1f5f9; --surface: #ffffff;
            --border: #e2e8f0; --text-main: #1e293b; --text-muted: #64748b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; color: var(--text-main); font-size: 12px; line-height: 1.4; overflow-x: hidden; }

        /* Loader IA */
        #ai-loader-inline {
            display: none; align-items: center; gap: 8px; color: var(--primary);
            font-weight: 800; font-size: 10px; text-transform: uppercase; margin-bottom: 5px; padding: 0 20px;
        }
        .dot-pulse { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; animation: pulse-glow 1s infinite alternate; }
        @keyframes pulse-glow { from { opacity: 0.3; transform: scale(0.8); } to { opacity: 1; transform: scale(1.2); } }

        /* Header */
        .header-enterprise {
            background: var(--secondary); color: white; padding: 12px 16px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .header-enterprise h2 { margin: 0; font-size: 14px; font-weight: 800; text-transform: uppercase; }

        /* Modais */
        .generic-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px);
            z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content {
            background: var(--surface); width: 100%; max-width: 500px;
            border-radius: 12px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            max-height: 85vh; display: flex; flex-direction: column;
        }
        .modal-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { overflow-y: auto; flex: 1; padding: 15px; }

        /* Container Principal */
        .painel-container { max-width: 1100px; margin: 0 auto; padding: 12px; padding-bottom: 160px; }

        /* Busca IA */
        .smart-search-area {
            background: var(--surface); border: 2px solid var(--primary);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .search-row { display: flex; gap: 8px; }
        .search-row input { flex: 1; padding: 12px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 14px; }
        .btn-search { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: 800; }

        .results-dropdown { 
            background: white; border: 1px solid var(--border); max-height: 250px; 
            overflow-y: auto; margin-top: 8px; display: none; border-radius: 8px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        .result-item { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .result-item:hover { background: #f1f5f9; }

        /* Cards Estilizados */
        .secao-card { 
            background: var(--surface); border: 1px solid var(--border); 
            border-radius: 10px; padding: 15px; margin-bottom: 12px; position: relative;
        }
        .secao-card h3 { 
            margin: 0 0 12px 0; font-size: 11px; text-transform: uppercase; 
            color: var(--text-muted); display: flex; align-items: center; gap: 8px;
            border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; font-weight: 800;
        }

        .toggle-btn {
            position: absolute; right: 15px; top: 12px; background: #f1f5f9; 
            border: 1px solid var(--border); padding: 4px 8px; border-radius: 6px; 
            font-size: 9px; font-weight: 800; color: var(--primary); cursor: pointer;
        }

        .grid-compact { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .campo-grupo { margin-bottom: 10px; position: relative; }
        .campo-grupo label { font-weight: 700; font-size: 9px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        input, textarea, select { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; outline: none; }
        
        .ai-chip { flex: 1; padding: 8px; background: white; border: 1px solid var(--border); border-radius: 8px; font-size: 10px; text-align: center; cursor: pointer; font-weight: 800; }
        .ai-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .btn-inspect { position: absolute; right: 8px; top: 22px; background: #f1f5f9; border: none; padding: 4px 8px; border-radius: 5px; color: var(--primary); font-size: 11px; }
        .inspect-viewer { margin-top: 10px; background: #000; border-radius: 10px; overflow: hidden; display: none; width: 100%; aspect-ratio: 16/9; }
        .inspect-viewer iframe, .inspect-viewer img { width: 100%; height: 100%; border: none; }

        .btn-add { padding: 10px; font-size: 11px; font-weight: 800; border: 2px dashed var(--border); border-radius: 8px; background: #f8fafc; color: var(--text-muted); width: 100%; cursor: pointer; margin-bottom: 10px; }
        .item-flex { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .btn-remover { background: #fee2e2; color: var(--danger); border: none; padding: 8px 12px; border-radius: 8px; font-weight: 800; cursor: pointer; }

        /* Ações Fixas */
        .acoes-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            border-top: 1px solid var(--border); padding: 10px 15px 20px 15px; z-index: 1001;
        }
        .acoes { display: flex; gap: 8px; }
        .btn-main { padding: 12px; border: none; border-radius: 8px; font-weight: 800; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-save { background: var(--primary); color: white; flex: 2; }
        .btn-delete { background: #fee2e2; color: var(--danger); flex: 0.5; }
        .btn-sec { background: var(--secondary); color: white; flex: 1; }

        .status { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); padding: 10px 25px; border-radius: 30px; font-size: 12px; font-weight: 800; z-index: 3000; display: none; color: white; }
    </style>
</head>
<body>

<div id="msgStatus" class="status"></div>

<div id="dbModal" class="generic-modal" onclick="if(event.target==this) fecharModais()">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fa-solid fa-cloud"></i> NUVEM ANIGEEK</h3>
            <button onclick="fecharModais()">×</button>
        </div>
        <div style="padding:12px; background:#f8fafc; border-bottom:1px solid var(--border)">
            <input type="text" id="dbSearch" placeholder="Pesquisar..." oninput="filtrarDB()">
        </div>
        <div id="dbList" class="modal-body"></div>
    </div>
</div>

<div id="collectionModal" class="generic-modal" onclick="if(event.target==this) fecharModais()">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fa-solid fa-folder-tree"></i> COLEÇÃO</h3>
            <button onclick="fecharModais()">×</button>
        </div>
   <div class="modal-body">
    <button onclick="selecionarColecao('meliodas.web.app/animes_filmes_series_games_noticias/Jujutsu_kaisen_shimetsu_kaiyu', 'Jujutsu Kaisen: Shimetsu Kaiyu')" 
            style="width:100%; padding:12px; margin-bottom:8px; font-weight:800; border-radius:8px; border:1px solid #e2e8f0; cursor:pointer;">
        <i class="fa-solid fa-fire-flame-curved"></i> Jujutsu Kaisen: Shimetsu Kaiyu
    </button>

    <button onclick="selecionarColecao('meliodas.web.app/animes_filmes_series_games_noticias/saihate_no_paladin', 'Saihate no Paladin')" 
            style="width:100%; padding:12px; margin-bottom:8px; border-radius:8px; border:1px solid #e2e8f0; cursor:pointer;">
        Saihate no Paladin
    </button>

    <button onclick="selecionarColecao('anime_i_geek', 'Anime i Geek')" 
            style="width:100%; padding:12px; margin-bottom:8px; border-radius:8px; border:1px solid #e2e8f0; cursor:pointer;">
        Anime i Geek
    </button>

    <button onclick="selecionarColecao('meliodas.web.app/animes_filmes_series_games_noticias/chainsaw_man', 'Chainsaw Man')" 
            style="width:100%; padding:12px; border-radius:8px; border:1px solid #e2e8f0; cursor:pointer;">
        Chainsaw Man
    </button>
</div>

    </div>
</div>

<header class="header-enterprise">
    <h2><i class="fa-solid fa-brain"></i> ANIGEEK AI STUDIO</h2>
    <span style="font-size:9px; background:var(--primary); padding:4px 8px; border-radius:4px;">V12.0 ULTIMATE</span>
</header>

<div class="painel-container">
    
    <div class="secao-card" style="border: 2px solid var(--warning);">
        <h3><i class="fa-solid fa-bullhorn" style="color: var(--warning);"></i> Configurações Globais de Anúncio</h3>
        <div class="campo-grupo">
            <label>Link de Redirecionamento PADRÃO (Propaganda do Player)</label>
            <input type="text" id="globalLinkPropaganda" placeholder="https://www.effectivegatecpm.com/...">
        </div>
        <div class="campo-grupo">
            <label>Script/HTML do Banner Topo PADRÃO</label>
            <textarea id="globalBannerTopo" style="min-height: 80px;" placeholder="Cole o script ou link do banner padrão aqui"></textarea>
        </div>
        <div class="campo-grupo">
            <label>Script/HTML do Banner Fundo PADRÃO</label>
            <textarea id="globalBannerFundo" style="min-height: 80px;" placeholder="Cole o script ou link do banner padrão aqui"></textarea>
        </div>
        <button class="btn-main btn-sec" style="width: 100%; background: var(--warning); color: #000;" onclick="salvarConfigAds()">
            <i class="fa-solid fa-save"></i> SALVAR CONFIGURAÇÕES GLOBAIS
        </button>
    </div>

    <div class="smart-search-area">
        <div class="search-row">
            <input type="text" id="animeQuery" placeholder="1. Buscar Anime no MyAnimeList...">
            <button class="btn-search" onclick="buscarAnime()"><i class="fa-solid fa-wand-sparkles"></i></button>
        </div>
        <div id="animeResults" class="results-dropdown"></div>

        <div id="episodeArea" style="display:none; margin-top: 15px; border-top: 1px solid var(--border); padding-top:15px;">
            <label style="font-size:9px; font-weight:800; color:var(--primary); display:block; margin-bottom:8px;">2. REFINAR DOCUMENTO</label>
            <select id="episodeSelect" style="margin-bottom: 12px;"><option value="series_main">Página Principal</option></select>
            <div class="ai-options" style="display:flex; gap:8px; margin-bottom:12px;">
                <div class="ai-chip" onclick="setAiMode('short', this)">Curto</div>
                <div class="ai-chip active" onclick="setAiMode('medium', this)">Narrativo</div>
                <div class="ai-chip" onclick="setAiMode('long', this)">Completo</div>
            </div>
            <button class="btn-search" style="background:var(--success); width: 100%;" onclick="carregarEpisodio()">
                <i class="fa-solid fa-bolt"></i> EXTRAIR COM IA REAL (GEMINI)
            </button>
        </div>
    </div>

    <div class="grid-compact" style="margin-bottom: 12px;">
        <div class="campo-grupo">
            <label>Coleção Ativa</label>
            <input type="text" id="colecaoDisplay" readonly value="" onclick="abrirModalColecao()" style="cursor:pointer; font-weight:800; color:var(--primary);">
            <input type="hidden" id="colecaoAlvo" value="">
        </div>
        <div class="campo-grupo">
            <label id="ordemLabel">Ordem de Exibição</label>
            <input type="number" id="ordemNoticia" value="1">
        </div>
    </div>

    <div class="form-corpo">
        
        <div class="secao-card" style="border-left: 5px solid var(--analytics);">
            <h3><i class="fa-solid fa-chart-pie" style="color: var(--analytics);"></i> Analytics & Monitoramento de Visitantes</h3>
            <div class="grid-compact">
                <div class="campo-grupo">
                    <label>Total Visitantes Únicos</label>
                    <input type="text" id="statsVisitantes" readonly value="0" style="background:#f8fafc; font-weight:bold; color:var(--analytics);">
                </div>
                <div class="campo-grupo">
                    <label>Cliques no Player</label>
                    <input type="text" id="statsPlayer" readonly value="0" style="background:#f8fafc;">
                </div>
                <div class="campo-grupo">
                    <label>Cliques em Anúncios</label>
                    <input type="text" id="statsAds" readonly value="0" style="background:#f8fafc;">
                </div>
            </div>
            
            <div class="campo-grupo">
                <label>Log de Atividade Recente (Visitantes)</label>
                <div id="logAtividades" style="max-height: 150px; overflow-y: auto; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                    <div style="font-size:10px; color:var(--text-muted); text-align:center;">Selecione um documento para carregar os dados.</div>
                </div>
            </div>
        </div>

        <div class="secao-card">
            <h3><i class="fa-solid fa-fingerprint"></i> Identidade Digital</h3>
            <div class="campo-grupo">
                <label>Título Traduzido</label>
                <input type="text" id="titulo" oninput="gerarSlug(this.value)" placeholder="Título do Card">
            </div>
            <div class="grid-compact">
                <div class="campo-grupo"><label>Slug/ID</label><input type="text" id="docId" readonly style="background:#f8fafc"></div>
                <div class="campo-grupo">
                    <label>Hashtags</label>
                    <input type="text" id="categoria" placeholder="Ação, Drama...">
                </div>
            </div>
            <div class="campo-grupo"><label>Cor Identidade</label><input type="color" id="cor" value="#4f46e5" style="height:38px; padding:2px;"></div>
        </div>

        <div class="secao-card" style="border-left: 5px solid var(--accent);">
            <h3><i class="fa-solid fa-rectangle-ad" style="color: var(--accent);"></i> Anúncios Exclusivos Deste Artigo</h3>
            <div class="campo-grupo">
                <label>Link de Propaganda Exclusivo (Player)</label>
                <input type="text" id="linkPropagandaArtigo" placeholder="Deixe em branco para usar o Global">
            </div>
            <div class="campo-grupo">
                <label>Script/HTML Banner Exclusivo (Abaixo dos Produtos)</label>
                <textarea id="bannerAd" style="min-height: 80px;" placeholder="Script ou imagem que aparecerá apenas neste artigo"></textarea>
            </div>
        </div>

        <div class="secao-card">
            <h3><i class="fa-solid fa-photo-film"></i> Ativos de Mídia</h3>
            <div class="campo-grupo">
                <label>Thumbnail Card (16:9)</label>
                <input type="text" id="capaNoticia">
                <button class="btn-inspect" onclick="inspectMedia('capaNoticia')"><i class="fa-solid fa-eye"></i></button>
                <div id="viewer-capaNoticia" class="inspect-viewer"></div>
            </div>
            <div class="grid-compact">
                <div class="campo-grupo">
                    <label>Banner HD Hero</label>
                    <input type="text" id="capaUrl">
                    <button class="btn-inspect" onclick="inspectMedia('capaUrl')"><i class="fa-solid fa-image"></i></button>
                    <div id="viewer-capaUrl" class="inspect-viewer"></div>
                </div>
                <div class="campo-grupo"><label>Texto Banner</label><input type="text" id="capaDesc"></div>
            </div>
            <div class="campo-grupo">
                <label>ID YouTube ou Link Google Drive</label>
                <input type="text" id="videoPrincipal" placeholder="Ex: dQw4w9WgXcQ ou link do Drive">
                <button class="btn-inspect" onclick="inspectMedia('videoPrincipal')"><i class="fa-solid fa-play"></i></button>
                <div id="viewer-videoPrincipal" class="inspect-viewer"></div>
            </div>
        </div>

        <div class="secao-card">
            <h3><i class="fa-solid fa-pen-fancy"></i> Redação Inteligente</h3>
            <button class="toggle-btn" onclick="rephraseContent()"><i class="fa-solid fa-wand-magic-sparkles"></i> IA REESCREVER</button>
            <div class="campo-grupo">
                <label>Conteúdo da Notícia/Review</label>
                <textarea id="resumo" style="min-height: 220px;"></textarea>
            </div>
            <div class="campo-grupo">
                <label>Fonte de Referência (Link Externo)</label>
                <input type="text" id="linkArtigo" placeholder="https://...">
            </div>
        </div>

        <div class="secao-card">
            <h3><i class="fa-solid fa-list-check"></i> Ficha Técnica Detalhada</h3>
            <div id="container-ficha"></div>
            <button class="btn-add" onclick="adicionarFicha()">+ Adicionar Atributo</button>
        </div>

        <div class="grid-compact">
            <div class="secao-card">
                <h3><i class="fa-solid fa-user-gear"></i> Editor</h3>
                <div class="campo-grupo"><label>Avatar</label><input type="text" id="perfilImg"></div>
                <div id="container-ficha-editor"></div>
                <button class="btn-add" onclick="adicionarFichaEditor()">+ Cargo</button>
            </div>
            <div class="secao-card">
                <h3><i class="fa-solid fa-chart-line"></i> Métricas (Públicas)</h3>
                <div class="campo-grupo"><label>Likes</label><input type="number" id="curtidas" value="0"></div>
                <div class="campo-grupo"><label>Views Totais</label><input type="number" id="visualizacoes" value="0"></div>
            </div>
        </div>

        <div class="secao-card">
            <h3><i class="fa-brands fa-youtube"></i> Vídeos Vinculados (YouTube)</h3>
            <div id="container-relacionados"></div>
            <button class="btn-add" onclick="adicionarRelacionado()">+ Vincular Vídeo</button>
        </div>

        <div class="secao-card">
            <h3><i class="fa-solid fa-cart-shopping"></i> Vitrine de Produtos</h3>
            <div id="container-produtos"></div>
            <button class="btn-add" onclick="adicionarProduto()">+ Adicionar Produto</button>
        </div>
    </div>
</div>

<div class="acoes-wrapper">
    <div id="ai-loader-inline"><div class="dot-pulse"></div><span id="loader-text-inline">IA PROCESSANDO...</span></div>
    <div class="acoes">
        <button class="btn-main btn-delete" onclick="deletarDocumento()"><i class="fa-solid fa-trash-can"></i></button>
        <button class="btn-main btn-sec" onclick="abrirModalColecao()"><i class="fa-solid fa-folder-tree"></i> COLEÇÃO</button>
        <button class="btn-main btn-sec" onclick="toggleCloud()"><i class="fa-solid fa-database"></i> BANCO</button>
        <button class="btn-main btn-save" onclick="salvarGeral()"><i class="fa-solid fa-cloud-arrow-up"></i> PUBLICAR NO FIREBASE</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBC_ad4X9OwCHKvcG_pNQkKEl76Zw2tu6o",
      authDomain: "anigeeknews.firebaseapp.com",
      projectId: "anigeeknews",
      storageBucket: "anigeeknews.firebasestorage.app",
      messagingSenderId: "769322939926",
      appId: "1:769322939926:web:6eb91a96a3f74670882737"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let currentAnimeData = null;
    let aiMode = 'medium';

    // SALVAMENTO DE CONFIGS GLOBAIS
    window.salvarConfigAds = async () => {
        setLoader(true, "SALVANDO ANÚNCIOS...");
        const dadosAds = {
            linkPropaganda: document.getElementById('globalLinkPropaganda').value,
            bannerTopo: document.getElementById('globalBannerTopo').value,
            bannerFundo: document.getElementById('globalBannerFundo').value
        };
        try {
            await setDoc(doc(db, "configuracoes", "ads"), dadosAds);
            setLoader(false);
            mostrarStatus("ADS GLOBAIS ATUALIZADOS!", "var(--warning)");
        } catch(e) { setLoader(false); alert("Erro ao salvar Ads"); }
    };

    async function carregarConfigAds() {
        const snap = await getDoc(doc(db, "configuracoes", "ads"));
        if(snap.exists()){
            const d = snap.data();
            document.getElementById('globalLinkPropaganda').value = d.linkPropaganda || '';
            document.getElementById('globalBannerTopo').value = d.bannerTopo || '';
            document.getElementById('globalBannerFundo').value = d.bannerFundo || '';
        }
    }

    // IA E TRADUÇÃO
    async function callGeminiAI(prompt) {
        return await smartTranslate(prompt, "en|pt-BR");
    }

    async function smartTranslate(text, pair = "en|pt-BR") {
        if (!text) return "";
        const chunks = text.match(/.{1,450}/g) || [text];
        let results = [];
        for (const chunk of chunks) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(chunk)}&langpair=${pair}`);
                const data = await res.json();
                results.push(data.responseData.translatedText || chunk);
            } catch (e) { results.push(chunk); }
        }
        return results.join("");
    }

    window.setAiMode = (mode, el) => {
        aiMode = mode;
        document.querySelectorAll('.ai-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    };

    // MODAIS
    window.fecharModais = () => document.querySelectorAll('.generic-modal').forEach(m => m.style.display = 'none');
    window.abrirModalColecao = () => document.getElementById('collectionModal').style.display = 'flex';
    window.toggleCloud = async () => {
        document.getElementById('dbModal').style.display = 'flex';
        await carregarListaCloud();
    };

    window.selecionarColecao = (id, nome) => {
        document.getElementById('colecaoAlvo').value = id;
        document.getElementById('colecaoDisplay').value = nome;
        fecharModais();
        carregarListaCloud();
    };

    function setLoader(show, text = "") {
        const loader = document.getElementById('ai-loader-inline');
        const txt = document.getElementById('loader-text-inline');
        loader.style.display = show ? 'flex' : 'none';
        if(text) txt.innerText = text;
    }

    window.rephraseContent = async () => {
        const txt = document.getElementById('resumo').value;
        if(!txt) return;
        setLoader(true, "GEMINI REELABORANDO TEXTO...");
        const en = await smartTranslate(txt, "pt-BR|en");
        const pt = await smartTranslate(en, "en|pt-BR");
        document.getElementById('resumo').value = pt;
        setLoader(false);
        mostrarStatus("TEXTO REESCRITO COM IA", "var(--success)");
    };

    // BUSCA MAL
    window.buscarAnime = () => {
        const q = document.getElementById('animeQuery').value;
        const resBox = document.getElementById('animeResults');
        if(q.length < 3) return;
        resBox.style.display = 'block';
        resBox.innerHTML = '<div class="result-item">Buscando na MAL...</div>';
        fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(q)}&limit=5`)
            .then(r => r.json()).then(d => {
                resBox.innerHTML = '';
                d.data.forEach(a => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `<strong>${a.title}</strong><br><small>${a.type} • ${a.year || ''}</small>`;
                    div.onclick = () => selecionarSerie(a);
                    resBox.appendChild(div);
                });
            });
    };

    async function selecionarSerie(anime) {
        currentAnimeData = anime;
        document.getElementById('animeResults').style.display = 'none';
        document.getElementById('animeQuery').value = anime.title;
        document.getElementById('episodeArea').style.display = 'block';
        
        const sel = document.getElementById('episodeSelect');
        sel.innerHTML = '<option value="series_main">Página Principal</option>';
        try {
            const r = await fetch(`https://api.jikan.moe/v4/anime/${anime.mal_id}/episodes`);
            const data = await r.json();
            data.data.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.mal_id; opt.innerText = `Episódio ${e.mal_id}: ${e.title}`;
                opt.dataset.title = e.title;
                sel.appendChild(opt);
            });
        } catch(err) {}
    }

    window.carregarEpisodio = async () => {
        if(!currentAnimeData) return;
        setLoader(true, "IA EXTRAINDO DADOS...");
        
        const select = document.getElementById('episodeSelect');
        let titleRaw = currentAnimeData.title;
        if (select.value !== 'series_main') titleRaw = `EP ${select.value} - ${select.selectedOptions[0].dataset.title}`;

        const [tit, sin] = await Promise.all([
            callGeminiAI(titleRaw),
            callGeminiAI(currentAnimeData.synopsis)
        ]);

        document.getElementById('titulo').value = tit;
        gerarSlug(tit);
        document.getElementById('resumo').value = sin;
        document.getElementById('categoria').value = currentAnimeData.genres.map(g=>g.name).join(', ');
        document.getElementById('capaNoticia').value = currentAnimeData.images.jpg.large_image_url;
        document.getElementById('capaUrl').value = currentAnimeData.images.jpg.large_image_url;
        document.getElementById('capaDesc').value = currentAnimeData.title;

        const f = document.getElementById('container-ficha'); f.innerHTML = '';
        adicionarFicha("Título Original", currentAnimeData.title_japanese || "N/A");
        adicionarFicha("Estúdio", currentAnimeData.studios[0]?.name || "N/A");
        adicionarFicha("Temporada", currentAnimeData.season ? `${currentAnimeData.season} ${currentAnimeData.year}` : "N/A");
        adicionarFicha("Fonte", currentAnimeData.source || "N/A");
        adicionarFicha("Score MAL", currentAnimeData.score || "N/A");
        adicionarFicha("Popularidade", `#${currentAnimeData.popularity}`);
        adicionarFicha("Membros", currentAnimeData.members.toLocaleString());
        adicionarFicha("Licença", currentAnimeData.licensors[0]?.name || "N/A");

        setLoader(false);
        mostrarStatus("DADOS SINCRONIZADOS", "var(--success)");
    };

    // FORMULÁRIO DINÂMICO
    window.adicionarFicha = (l='', v='') => {
        const d = document.createElement('div'); d.className = 'item-flex';
        d.innerHTML = `<input type="text" class="f-label" value="${l}" placeholder="Label"><input type="text" class="f-valor" value="${v}" placeholder="Valor"><button class="btn-remover" onclick="this.parentElement.remove()">×</button>`;
        document.getElementById('container-ficha').appendChild(d);
    };

    window.adicionarFichaEditor = (l='', v='') => {
        const d = document.createElement('div'); d.className = 'item-flex';
        d.innerHTML = `<input type="text" class="fe-label" value="${l}" placeholder="Cargo"><input type="text" class="fe-valor" value="${v}" placeholder="Nome"><button class="btn-remover" onclick="this.parentElement.remove()">×</button>`;
        document.getElementById('container-ficha-editor').appendChild(d);
    };

    window.adicionarRelacionado = (id='', t='', th='') => {
        const d = document.createElement('div'); d.style.cssText = "background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:10px;";
        d.innerHTML = `<div class="item-flex"><input type="text" class="r-id" value="${id}" placeholder="ID YouTube"><button class="btn-remover" onclick="this.parentElement.remove()">×</button></div><input type="text" class="r-titulo" value="${t}" placeholder="Título Vídeo" style="margin-bottom:4px"><input type="text" class="r-thumb" value="${th}" placeholder="Thumb (Opcional)">`;
        document.getElementById('container-relacionados').appendChild(d);
    };

    window.adicionarProduto = (n='', l='', i='', ds='') => {
        const d = document.createElement('div'); d.style.cssText = "background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:10px;";
        d.innerHTML = `<div class="item-flex"><input type="text" class="p-nome" value="${n}" placeholder="Nome"><button class="btn-remover" onclick="this.parentElement.remove()">×</button></div><input type="text" class="p-link" value="${l}" placeholder="Link Loja" style="margin-bottom:4px"><input type="text" class="p-img" value="${i}" placeholder="URL Imagem" style="margin-bottom:4px"><textarea class="p-desc" placeholder="Descrição">${ds}</textarea>`;
        document.getElementById('container-produtos').appendChild(d);
    };

    // FIREBASE - SALVAR E CARREGAR
    window.salvarGeral = async () => {
        const id = document.getElementById('docId').value;
        const col = document.getElementById('colecaoAlvo').value;
        if(!id) return alert("Slug necessário");
        
        setLoader(true, "SALVANDO...");
        const dados = {
            ordem: parseInt(document.getElementById('ordemNoticia').value) || 0,
            titulo: document.getElementById('titulo').value,
            categoria: document.getElementById('categoria').value,
            resumo: document.getElementById('resumo').value,
            cor: document.getElementById('cor').value,
            linkArtigo: document.getElementById('linkArtigo').value,
            videoPrincipal: document.getElementById('videoPrincipal').value,
            capaNoticia: document.getElementById('capaNoticia').value,
            capaUrl: document.getElementById('capaUrl').value,
            capaDesc: document.getElementById('capaDesc').value,
            bannerAd: document.getElementById('bannerAd').value, 
            linkPropagandaArtigo: document.getElementById('linkPropagandaArtigo').value,
            curtidas: parseInt(document.getElementById('curtidas').value) || 0,
            visualizacoes: parseInt(document.getElementById('visualizacoes').value) || 0,
            fichaCategoria: {
                perfilImg: document.getElementById('perfilImg').value,
                info: Array.from(document.querySelectorAll('#container-ficha-editor .item-flex')).map(el => ({ label: el.querySelector('.fe-label').value, valor: el.querySelector('.fe-valor').value }))
            },
            ficha: Array.from(document.querySelectorAll('#container-ficha .item-flex')).map(el => ({ label: el.querySelector('.f-label').value, valor: el.querySelector('.f-valor').value })),
            relacionados: Array.from(document.querySelectorAll('#container-relacionados > div')).map(el => ({ idVid: el.querySelector('.r-id').value, titulo: el.querySelector('.r-titulo').value, thumb: el.querySelector('.r-thumb').value })),
            produtos: Array.from(document.querySelectorAll('#container-produtos > div')).map(el => ({ nome: el.querySelector('.p-nome').value, link: el.querySelector('.p-link').value, img: el.querySelector('.p-img').value, desc: el.querySelector('.p-desc').value })),
            timestamp: Date.now()
        };

        try {
            await setDoc(doc(db, col, id), dados, { merge: true });
            setLoader(false); mostrarStatus("SALVO NA NUVEM!", "var(--success)");
            carregarListaCloud();
        } catch (e) { setLoader(false); alert("Erro ao salvar"); }
    };

    // --- FUNÇÃO DE ANALYTICS (NOVA) ---
    window.carregarAnalytics = async (col, docId) => {
        const statsVisitantes = document.getElementById('statsVisitantes');
        const statsPlayer = document.getElementById('statsPlayer');
        const statsAds = document.getElementById('statsAds');
        const logArea = document.getElementById('logAtividades');
        
        // Reset UI
        statsVisitantes.value = "...";
        statsPlayer.value = "...";
        statsAds.value = "...";
        logArea.innerHTML = '<div style="font-size:10px; color:var(--text-muted); text-align:center;">Carregando dados de visitantes...</div>';

        try {
            // Acessa a subcoleção 'visitantes' dentro do documento atual
            // Estrutura esperada: colecao > documento > visitantes > {id_visitante}
            const visitantesRef = collection(db, col, docId, "visitantes");
            const snapshot = await getDocs(visitantesRef);

            let totalV = snapshot.size;
            let totalPlayer = 0;
            let totalAds = 0;
            let logHTML = "";

            if (snapshot.empty) {
                logArea.innerHTML = '<div style="font-size:10px; color:var(--text-muted); text-align:center;">Nenhum visitante registrado ainda.</div>';
                statsVisitantes.value = 0;
                statsPlayer.value = 0;
                statsAds.value = 0;
                return;
            }

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const visitorId = docSnap.id;
                
                // Calcula ações baseadas em um array de ações (exemplo)
                // Estrutura esperada do dado do visitante: 
                // { actions: [{type: 'player_click', ts: 123}, {type: 'ad_click', ts: 124}] }
                let actionsCount = 0;
                if (data.actions && Array.isArray(data.actions)) {
                    actionsCount = data.actions.length;
                    data.actions.forEach(act => {
                        if(act.type === 'player_click' || act.type === 'player') totalPlayer++;
                        if(act.type === 'ad_click' || act.type === 'ad') totalAds++;
                    });
                }

                // Adiciona ao log visual (ID parcial para não ocupar muito espaço)
                logHTML += `
                    <div style="font-size:10px; border-bottom:1px solid #eee; padding:6px; display:flex; justify-content:space-between;">
                        <span><i class="fa-solid fa-user-secret"></i> ...${visitorId.slice(-8)}</span>
                        <span><b>${actionsCount}</b> Ações</span>
                    </div>
                `;
            });

            statsVisitantes.value = totalV;
            statsPlayer.value = totalPlayer;
            statsAds.value = totalAds;
            logArea.innerHTML = logHTML;

        } catch (e) {
            console.error(e);
            logArea.innerHTML = '<div style="font-size:10px; color:var(--danger); text-align:center;">Erro ao carregar Analytics.</div>';
        }
    };

    window.carregarPorID = async (id) => {
        setLoader(true);
        const col = document.getElementById('colecaoAlvo').value;
        
        // 1. Carregar Documento Principal
        const snap = await getDoc(doc(db, col, id));
        
        if(snap.exists()){
            const d = snap.data();
            document.getElementById('docId').value = id;
            document.getElementById('ordemNoticia').value = d.ordem || 0;
            document.getElementById('titulo').value = d.titulo || '';
            document.getElementById('resumo').value = d.resumo || '';
            document.getElementById('categoria').value = d.categoria || '';
            document.getElementById('capaNoticia').value = d.capaNoticia || '';
            document.getElementById('capaUrl').value = d.capaUrl || '';
            document.getElementById('capaDesc').value = d.capaDesc || '';
            document.getElementById('bannerAd').value = d.bannerAd || ''; 
            document.getElementById('linkPropagandaArtigo').value = d.linkPropagandaArtigo || '';
            document.getElementById('curtidas').value = d.curtidas || 0;
            document.getElementById('visualizacoes').value = d.visualizacoes || 0;
            document.getElementById('linkArtigo').value = d.linkArtigo || '';
            document.getElementById('videoPrincipal').value = d.videoPrincipal || '';
            document.getElementById('perfilImg').value = d.fichaCategoria?.perfilImg || '';
            
            document.getElementById('container-ficha').innerHTML = '';
            d.ficha?.forEach(f => adicionarFicha(f.label, f.valor));
            document.getElementById('container-ficha-editor').innerHTML = '';
            d.fichaCategoria?.info?.forEach(i => adicionarFichaEditor(i.label, i.valor));
            document.getElementById('container-relacionados').innerHTML = '';
            d.relacionados?.forEach(r => adicionarRelacionado(r.idVid, r.titulo, r.thumb));
            document.getElementById('container-produtos').innerHTML = '';
            d.produtos?.forEach(p => adicionarProduto(p.nome, p.link, p.img, p.desc));

            // 2. Carregar Analytics (Visitantes)
            await carregarAnalytics(col, id);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        setLoader(false);
    };

    async function carregarListaCloud() {
        const col = document.getElementById('colecaoAlvo').value;
        const q = query(collection(db, col), orderBy("ordem", "asc"));
        const snap = await getDocs(q);
        const listEl = document.getElementById('dbList');
        listEl.innerHTML = '';
        snap.forEach(d => {
            const data = d.data();
            const btn = document.createElement('button');
            btn.className = 'btn-main btn-sec';
            btn.style.width = '100%'; btn.style.marginBottom = '6px';
            btn.innerHTML = `<span style="flex:1; text-align:left">#${data.ordem} - ${data.titulo}</span> <i class="fa-solid fa-chevron-right"></i>`;
            btn.onclick = () => { carregarPorID(d.id); fecharModais(); };
            listEl.appendChild(btn);
        });
    }

    // UTILITÁRIOS
    window.inspectMedia = (fieldId) => {
        let val = document.getElementById(fieldId).value.trim();
        const viewer = document.getElementById('viewer-' + fieldId);
        if(!val) return;
        
        if(viewer.style.display === 'block') { 
            viewer.style.display = 'none'; 
            return; 
        }

        if (val.includes('drive.google.com')) {
            let driveUrl = val;
            if (val.includes('/file/d/')) {
                const id = val.split('/file/d/')[1].split('/')[0];
                driveUrl = `https://drive.google.com/file/d/${id}/preview`;
            } else if (val.includes('id=')) {
                const id = val.split('id=')[1].split('&')[0];
                driveUrl = `https://drive.google.com/file/d/${id}/preview`;
            }
            viewer.innerHTML = `<iframe src="${driveUrl}" allowfullscreen></iframe>`;
        } else if (val.length === 11 || val.includes('youtube') || val.includes('http://googleusercontent.com/youtube.com/')) {
            let id = val;
            if (val.includes('v=')) id = val.split('v=')[1].split('&')[0];
            else if (val.includes('http://googleusercontent.com/youtube.com/')) id = val.split('youtu.be/')[1].split('?')[0];
            viewer.innerHTML = `<iframe src="https://www.youtube.com/embed/$${id}" allowfullscreen></iframe>`;
        } else {
            viewer.innerHTML = `<img src="${val}" onerror="this.src='https://placehold.co/600x400?text=Midia+Invalida'">`;
        }
        
        viewer.style.display = 'block';
    };

    window.gerarSlug = (v) => {
        const s = v.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^\w ]+/g, '').replace(/ +/g, '-');
        document.getElementById('docId').value = s;
        document.getElementById('ordemLabel').innerHTML = `Ordem (DOC: ${s})`;
    };

    function mostrarStatus(txt, cor) {
        const s = document.getElementById('msgStatus');
        s.style.display = "block"; s.style.background = cor; s.innerText = txt;
        setTimeout(() => s.style.display = "none", 3000);
    }

    // DELETAR DOCUMENTO
    window.deletarDocumento = async () => {
        const id = document.getElementById('docId').value;
        const col = document.getElementById('colecaoAlvo').value;
        if(!id) return alert("Nenhum documento selecionado");
        if(!confirm("Tem certeza que deseja deletar este documento?")) return;
        
        setLoader(true, "DELETANDO...");
        try {
            await deleteDoc(doc(db, col, id));
            setLoader(false); mostrarStatus("DELETADO COM SUCESSO!", "var(--danger)");
            carregarListaCloud();
            // Limpa o form após deletar
            location.reload(); 
        } catch (e) { setLoader(false); alert("Erro ao deletar"); }
    };

    carregarListaCloud();
    carregarConfigAds(); 
</script>
</body>
</html>
